<!DOCTYPE html>
<html lang="de" >
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/>
	<meta name="HandheldFriendly" content="true"/>
        <title>Howto&colon; Duplikate mit rdfind finden und mit einem Hardlink ersetzen</title>
	<link rel="stylesheet" href="/css/201407230018.min.css"/>
	<link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    </head>
    <body>
	
	<div class="row" id="header">
		<h2 class="title"><a href="/">Erw&auml;hnenswert</a></h2>
	</div>

	<div class="site">
		<div class="row">
			<div class="col-md-8 content">
				
					<div class="post">
	<article itemscope itemtype="http://schema.org/Article">
		<header>
			<time datetime="2013-08-20T21:10:32Z" pubdate  class="date">20 Aug 2013</time>
			<h1 itemprop="headline">Howto&colon; Duplikate mit rdfind finden und mit einem Hardlink ersetzen</h1>
		</header>
		<text itemprop="text">
		Am Wochenende habe ich mir wieder mein lokales Backup angeschaut, um es dann wie jeden Monat auf die externe Platte zu spiegeln. Dabei ist aufgefallen, dass&nbsp;
<a href="http://backintime.le-web.org/">
  backintime
</a>
&nbsp;sehr intelligent nur die geänderten oder neuen Dateien übernimmt. Allerdings sind fallen Umbenennungen bzw. verschobene Dateien jedes Mal mit der vollen Größe ins Gewicht.
<br />

<p>
  Nun kommt 
  <a href="http://rdfind.pauldreik.se/" title="rdfind">
    rdfind
  </a>
  ins Spiel.
</p>
Mit dem Paketmanager installieren:  
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo apt-get install rdfind
</code></pre></div>

<h1>
  Step-by-Step Demo
</h1>

<div class="highlight"><pre><code class="bash"><span class="c"># emuliere eine Backupverzeichnisstruktur in /tmp</span>
<span class="nv">$ </span><span class="nb">cd</span> /tmp/
<span class="nv">$ </span>mkdir backup
<span class="nv">$ </span><span class="nb">cd </span>backup/
<span class="nv">$ </span>mkdir -p 2013/<span class="o">{</span>01..08<span class="o">}</span>/home/lars
<span class="c"># in jedem Verzeichnis &#39;lars&#39; eine 100M Datei erstellen</span>
<span class="nv">$ </span>find -type d -name lars -exec dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>100 <span class="nv">of</span><span class="o">={}</span>/x <span class="se">\;</span>
100+0 Datensätze ein
100+0 Datensätze aus
104857600 Bytes <span class="o">(</span>105 MB<span class="o">)</span> kopiert, 0,326316 s, 321 MB/s
100+0 Datensätze ein
100+0 Datensätze aus
104857600 Bytes <span class="o">(</span>105 MB<span class="o">)</span> kopiert, 0,274126 s, 383 MB/s
100+0 Datensätze ein
100+0 Datensätze aus
104857600 Bytes <span class="o">(</span>105 MB<span class="o">)</span> kopiert, 0,24677 s, 425 MB/s
100+0 Datensätze ein
100+0 Datensätze aus
104857600 Bytes <span class="o">(</span>105 MB<span class="o">)</span> kopiert, 0,243897 s, 430 MB/s
100+0 Datensätze ein
100+0 Datensätze aus
104857600 Bytes <span class="o">(</span>105 MB<span class="o">)</span> kopiert, 0,301347 s, 348 MB/s
100+0 Datensätze ein
100+0 Datensätze aus
104857600 Bytes <span class="o">(</span>105 MB<span class="o">)</span> kopiert, 0,268799 s, 390 MB/s
100+0 Datensätze ein
100+0 Datensätze aus
104857600 Bytes <span class="o">(</span>105 MB<span class="o">)</span> kopiert, 0,325733 s, 322 MB/s
100+0 Datensätze ein
100+0 Datensätze aus
104857600 Bytes <span class="o">(</span>105 MB<span class="o">)</span> kopiert, 0,248939 s, 421 MB/s
<span class="c"># aktuelle Platzverbrauch</span>
<span class="nv">$ </span>du -sh 
801M    .

<span class="nv">$ </span>rdfind -makehardlinks <span class="nb">true</span> *
Now scanning <span class="s2">&quot;2013&quot;</span>, found 8 files.
Now have 8 files in total.
Removed 0 files due to nonunique device and inode.
Now removing files with zero size from list...removed 0 files
Total size is 838860800 bytes or 800 Mib
Now sorting on size:removed 0 files due to unique sizes from list.8 files left.
Now eliminating candidates based on first bytes:removed 0 files from list.8 files left.
Now eliminating candidates based on last bytes:removed 0 files from list.8 files left.
Now eliminating candidates based on md5 checksum:removed 0 files from list.8 files left.
It seems like you have 8 files that are not unique
Totally, 700 Mib can be reduced.
Now making results file results.txt
Now making hard links.
Making 7 links.

<span class="nv">$ </span>du -sh 
101M .
</code></pre></div>

Das wurde hier an einer Datei demonstriert die in all ihren Kopien identisch ist, weil sie aus '0' besteht.  
<div class="highlight"><pre><code class="bash"><span class="c"># nun das ganze mit wild verstreuten Dateien</span>
<span class="c"># alte wegräumen</span>
<span class="nv">$ </span>find -type f -name x -exec rm <span class="o">{}</span> <span class="se">\;</span>
<span class="c"># in jedem Verzeichnis eine &#39;x&#39; 1MB groß</span>
<span class="nv">$ </span>find -type d -exec dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>1 <span class="nv">of</span><span class="o">={}</span>/x <span class="se">\;</span>

<span class="nv">$ </span>find
.
./2013
./2013/01
./2013/01/x
./2013/01/home
./2013/01/home/lars
./2013/01/home/lars/x
./2013/01/home/x
./2013/03
./2013/03/home/lars
./2013/03/home/lars/x
./2013/03/home/x
./2013/07
./2013/07/x
./2013/07/home
./2013/07/home/lars
./2013/07/home/lars/x
./2013/07/home/x
./2013/08
./2013/08/x
./2013/08/home
./2013/08/home/lars
./2013/08/home/lars/x
./2013/08/home/x
./2013/06
./2013/06/x
./2013/06/home
./2013/06/home/lars
./2013/06/home/lars/x
./2013/04/x
./2013/04/home
./2013/04/home/lars
./2013/04/home/lars/x
./2013/04/home/x
./2013/02
./2013/02/x
./2013/02/home
./2013/02/home/lars
./2013/02/home/lars/x
./2013/02/home/x
./2013/05
./2013/05/x
./2013/05/home
./2013/05/home/lars
./2013/05/home/lars/x
./2013/05/home/x
./x

<span class="c"># vorher</span>
<span class="nv">$ </span>du -sh 
27M .

<span class="nv">$ </span>rdfind -makehardlinks <span class="nb">true</span> *
Now scanning <span class="s2">&quot;2013&quot;</span>, found 25 files.
Now scanning <span class="s2">&quot;x&quot;</span>, found 1 files.
Now have 26 files in total.
Removed 0 files due to nonunique device and inode.
Now removing files with zero size from list...removed 0 files
Total size is 27262976 bytes or 26 Mib
Now sorting on size:removed 0 files due to unique sizes from list.26 files left.
Now eliminating candidates based on first bytes:removed 0 files from list.26 files left.
Now eliminating candidates based on last bytes:removed 0 files from list.26 files left.
Now eliminating candidates based on md5 checksum:removed 0 files from list.26 files left.
It seems like you have 26 files that are not unique
Totally, 25 Mib can be reduced.
Now making results file results.txt
Now making hard links.
Making 25 links.

<span class="c"># nachher</span>
<span class="nv">$ </span>du -sh 
1,2M .
</code></pre></div>
<p>
  Auf der Homepage 
  <a href="http://rdfind.pauldreik.se/">
    rdfind
  </a>
  ist der Algorithmus einfach dargestellt.  
  <div style="border:1px solid;padding:45px;">
    <H2 CLASS="western">
      <A NAME="g0.5">
      </A>
      Algorithm
    </H2>
    <P>
      Rdfind uses the following algorithm. If N is the number of files to search through, the effort required is in worst case O(Nlog(N)). Because it sorts files on inodes prior to disk reading, it is quite fast. It also only reads from disk when it is needed.
    </P>
    <OL>
      
      <LI>
        <P>
          Loop over each argument on the command line. Assign each  argument a priority number, in increasing order.
        </P>
        
        <LI>
          <P>
            For each argument, list the directory contents recursively  and assign it to the file list. Assign a directory depth number,  starting at 0 for every argument.
          </P>
          
          <LI>
            <P>
              If the input argument is a file, add it to the file list.
            </P>
            
            <LI>
              <P>
                Loop over the list, and find out the sizes of all files.
              </P>
              
              <LI>
                <P>
                  If flag -removeidentinode true: Remove items from the list  which already are added, based on the combination of inode and  device number. A group of files that are hardlinked to the same file  are collapsed to one entry. Also see the comment on hardlinks under  ”caveats below”!
                </P>
                
                <LI>
                  <P>
                    Sort files on size. Remove files from the list, which have  unique sizes.
                  </P>
                  
                  <LI>
                    <P>
                      Sort on device and inode(speeds up file reading). Read a few  bytes from the beginning of each file (first bytes).
                    </P>
                    
                    <LI>
                      <P>
                        Remove files from list that have the same size but different  first bytes.
                      </P>
                      
                      <LI>
                        <P>
                          Sort on device and inode(speeds up file reading). Read a few  bytes from the end of each file (last bytes).
                        </P>
                        
                        <LI>
                          <P>
                            Remove files from list that have the same size but different  last bytes.
                          </P>
                          
                          <LI>
                            <P>
                              Sort on device and inode(speeds up file reading). Perform a  checksum calculation for each file.
                            </P>
                            
                            <LI>
                              <P>
                                Only keep files on the list with the same size and checksum.  These are duplicates.
                              </P>
                              
                              <LI>
                                <P>
                                  Sort list on size, priority number, and depth. The first file  for every set of duplicates is considered to be the original.
                                </P>
                                
                                <LI>
                                  <P>
                                    If flag ”-makeresultsfile true”, then print results file  (default). Exit.(?)
                                  </P>
                                  
                                  <LI>
                                    <P>
                                      If flag ”-deleteduplicates true”, then delete (unlink)  duplicate files. Exit.
                                    </P>
                                    
                                    <LI>
                                      <P>
                                        If flag ”-makesymlinks true”, then replace duplicates  with a symbolic link to the original. Exit.
                                      </P>
                                      
                                      <LI>
                                        <P>
                                          If flag ”-makehardlinks true”, then replace duplicates  with a hard link to the original. Exit.
                                        </P>
      </OL>
</diV>

<h1>
  Fazit
</h1>
Einfach zu lernen. Ich hatte eine sehr gute 
<i>
  user experience
</i>
;).
		</text>
	</article>
	
	<div class="row" id="neighbors">
		<div class="col-xs-6 prev">			
			 
				<a href="/2013/06/22/Learning-from-mistakes-and-talk-about.html" rel="prev" title="Learning from mistakes and talk about">&laquo; previous</a> 
			 
		</div>
		<div class="col-xs-6 next">			
			 
				<a href="/2013/09/09/lint-maven-plugin---check-your-pom.xml.html" rel="next" title="lint-maven-plugin - check your pom.xml">next &raquo;</a> 
			 
		</div>
	</div>
</div>


   <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'lgohlke'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    


 

				
			</div>
			<div class="col-md-4 recent">
				<h3>recent posts</h3>
				
				<ul>
				
					
						
							<li><a href="/spam/phishing/funny/mails/2014/09/06/best-of-spam-part-I.html">BestOfSpam - +++Geheimdienst ermittelt+++</a></li>
						
					
						
							<li><a href="/sonarqube/plugin/sonar-mojobridge/2014/05/25/sonarqube-plugin-mojobridge-supports-sonarqube-4.2-and-above.html">SonarQube Mojo Bridge now supports Sonarqube 4.2 and above</a></li>
						
					
						
							<li><a href="/backup/system/perl/2014/05/18/clever-backup-compatibility-with-ubuntu-14.04.html">new release of clever-backup fixed compatibility issue with ubuntu 14.04</a></li>
						
					
						
							<li><a href="/ssh/security/hijacking/2014/05/18/SSH-Agent-Forwarding-Is-a-Bug.html">SSH Agent Forwarding Is a Bug</a></li>
						
					
						
							<li><a href="/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html">Rotate and convert videos automatically to h264 in the shell</a></li>
						
					
						
							<li><a href="/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html">Truecrypt mit Keyfiles und pam_exec automatisch mounten</a></li>
						
					
						
							<li><a href="/linux/2014/04/06/hibernate-and-resume-with-dm-crypt.html">hibernate and resume with dm-crypt under ubuntu</a></li>
						
					
						
							<li><a href="/2014/02/09/babyphone-mit-dem-raspberry-pi.html">Howto Babyphone mit dem Raspberry PI</a></li>
						
					
						
							<li><a href="/2014/02/04/thoughtworks-technology-radar-2014.html">Thoughtworks Technology Radar</a></li>
						
					
						
							<li><a href="/2014/01/31/Blog-Relaunch-mit-jekyll.html">Blog relaunched mit Jekyll</a></li>
						
					
						
							<li><a href="/2013/12/09/%22Leading-Change%22-in-einer-Agile-Company.html">Leading Change in einer Agile Company</a></li>
						
					
				
				
				</ul>
				




<div class="share42init" data-path="/img/">
	<span id="share42">
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -0px 0 no-repeat" href="https://www.evernote.com/clip.action?url=http://blog.lgohlke.de/2013/08/20/Howto%253A-Duplikate-mit-rdfind-finden-und-mit-einem-Hardlink-ersetzen.html&amp;title=Howto&colon;%20Duplikate%20mit%20rdfind%20finden%20und%20mit%20einem%20Hardlink%20ersetzen" title="Share on Evernote" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -32px 0 no-repeat" href="#" data-count="fb" onclick="window.open('http://www.facebook.com/sharer.php?u=http://blog.lgohlke.de/2013/08/20/Howto%253A-Duplikate-mit-rdfind-finden-und-mit-einem-Hardlink-ersetzen.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Facebook" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -64px 0 no-repeat" href="#" onclick="window.open('https://plus.google.com/share?url=http://blog.lgohlke.de/2013/08/20/Howto%253A-Duplikate-mit-rdfind-finden-und-mit-einem-Hardlink-ersetzen.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Google+" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -96px 0 no-repeat" href="#" data-count="pin" onclick="window.open('http://pinterest.com/pin/create/button/?url=http://blog.lgohlke.de/2013/08/20/Howto%253A-Duplikate-mit-rdfind-finden-und-mit-einem-Hardlink-ersetzen.html&amp;media=null&amp;description=Howto&colon;%20Duplikate%20mit%20rdfind%20finden%20und%20mit%20einem%20Hardlink%20ersetzen', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=600, height=300, toolbar=0, status=0');return false" title="Pin It" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -128px 0 no-repeat" href="#" data-count="twi" onclick="window.open('https://twitter.com/intent/tweet?text=Howto&colon;%20Duplikate%20mit%20rdfind%20finden%20und%20mit%20einem%20Hardlink%20ersetzen&amp;url=http://blog.lgohlke.de/2013/08/20/Howto%253A-Duplikate-mit-rdfind-finden-und-mit-einem-Hardlink-ersetzen.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Twitter" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -160px 0 no-repeat" href="/rss.xml" title="Subscribe to RSS feed" target="_blank"></a>
	</span>
</div>

			</div>
		</div>	
	</div>	
	<div id="footer">
	<div class="row contact" itemscope itemtype="http://schema.org/Person">
		<div class="col-xs-4">
			<span itemprop="name">Lars K.W. Gohlke</span>
		</div>
		<div class="col-xs-4">
			<a href="http://www.lgohlke.de/#impressum" itemprop="url" rel="prefetch">impressum</a>
		</div>
		<div class="col-xs-4">
			<a href="https://github.com/lkwg82">github.com/lkwg82</a><br />
		</div>
		
		<span class="version">last changed 2014-09-06 18:00:18 +0200 bd2c017539652abb7084e6a9ea47853b985fbdfd</span>
	</div>
	
</div>
	<script src="/js/ga.js" async></script>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </body>
</html>
