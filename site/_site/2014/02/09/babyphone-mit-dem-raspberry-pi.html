<!DOCTYPE html>
<html lang="de" >
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/>
	<meta name="HandheldFriendly" content="true"/>
        <title>Howto Babyphone mit dem Raspberry PI</title>
	<link rel="stylesheet" href="/css/201407230018.min.css"/>
	<link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    </head>
    <body>
	
	<div class="row" id="header">
		<h2 class="title"><a href="/">Erw&auml;hnenswert</a></h2>
	</div>

	<div class="site">
		<div class="row">
			<div class="col-md-8 content">
				
					<div class="post">
	<article itemscope itemtype="http://schema.org/Article">
		<header>
			<time datetime="2014-02-09T13:08:00Z" pubdate  class="date">09 Feb 2014</time>
			<h1 itemprop="headline">Howto Babyphone mit dem Raspberry PI</h1>
		</header>
		<text itemprop="text">
		<p>Bald ist es soweit und das Babyphone muss eingerichtet werden. Dazu habe ich mir die Webcam <a href="http://www.logitech.com/de-de/product/hd-pro-webcam-c920">Logitech C920</a> und <a href="http://de.wikipedia.org/wiki/Raspberry_Pi#Spezifikationen">Raspberry Pi Modell B</a> gekauft.</p>
<p>Hier nun meine kleine Anleitung um auf dem Handy Bild und Ton zu haben.</p>

<h2>Vorraussetzungen</h2>

Der PI hat Netzzugang und ihr k&ouml;nnt per SSH rauf.

<h2 id="bild">Schritte zum Erfolg - das Bild</h2>

Als erstes die Tools installieren:
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo apt-get update
<span class="nv">$ </span>sudo apt-get install build-essential libjpeg-dev imagemagick subversion libv4l-dev
</code></pre></div>

Dann <a href="http://sourceforge.net/projects/mjpg-streamer/">mjpg-streamer</a> installieren (leider gibt es noch kein Bin&auml;rpaket):

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span><span class="nb">cd</span> /tmp
<span class="nv">$ </span>svn co https://svn.code.sf.net/p/mjpg-streamer/code/mjpg-streamer mjpg-streamer
<span class="nv">$ </span><span class="nb">cd </span>mjpg-streamer
<span class="nv">$ </span>make <span class="nv">USE_LIBV4L2</span><span class="o">=</span><span class="nb">true</span> 
<span class="nv">$ </span>sudo make install
</code></pre></div>

MJPEG-Streamer als Dienst installieren mit diesem Init-skript:
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
<span class="c"># /etc/init.d/mjpg_streamer</span>

<span class="c">#</span>
<span class="c"># Creation:    04.02.2013</span>
<span class="c"># Last Update: 04.02.2013</span>
<span class="c">#</span>
<span class="c"># Written by Georg Kainzbauer (http://www.gtkdb.de)</span>
<span class="c">#</span>

<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides:          mjpg_streamer</span>
<span class="c"># Required-Start:    $all</span>
<span class="c"># Required-Stop:     $all</span>
<span class="c"># Default-Start:     2 3 4 5</span>
<span class="c"># Default-Stop:      0 1 6</span>
<span class="c"># Short-Description: MJPG-Streamer</span>
<span class="c"># Description:       MJPG-Streamer takes JPGs from Linux-UVC compatible webcams and streams them as M-JPEG via HTTP.</span>
<span class="c">### END INIT INFO</span>

start<span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Starting mjpg-streamer...&quot;</span>
  /usr/local/bin/mjpg_streamer -i <span class="s2">&quot;/usr/local/lib/input_uvc.so -d /dev/video0 -n&quot;</span> -o <span class="s2">&quot;/usr/local/lib/output_http.so -n -w /usr/local/www -p 8080&quot;</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1 <span class="p">&amp;</span>
<span class="o">}</span>

stop<span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Stopping mjpg-streamer...&quot;</span>
  <span class="nb">kill</span> -9 <span class="k">$(</span>pidof mjpg_streamer<span class="k">)</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1
<span class="o">}</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
  start<span class="o">)</span>
    start
    <span class="p">;;</span>
  stop<span class="o">)</span>
    stop
    <span class="p">;;</span>
  restart<span class="o">)</span>
    stop
    start
    <span class="p">;;</span>
  *<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 {start|stop|restart}&quot;</span>
    <span class="p">;;</span>
<span class="k">esac</span>

<span class="nb">exit </span>0
</code></pre></div>

und bitte beim n&auml;chsten Booten automatisch mitstarten
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo chmod 0755 /etc/init.d/mjpg_streamer
<span class="nv">$ </span>sudo update-rc.d mjpg_streamer defaults
</code></pre></div>

Zum Testen einfach den Dienst starten und dann unter <tt>http://&lt;ip&gt;:8080/</tt> anschauen.
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo service mjpg_streamer start
</code></pre></div>

Falls eure Webcam direkt MJPEG unterst&uuml;tzt, gibt es dieses Streaming f&uuml;r unter 5% cpu Last ;).

<div class="highlight"><pre><code class="bash">sudo v4l2-ctl --list-formats
ioctl: VIDIOC_ENUM_FMT
	Index       : 0
	Type        : Video Capture
	Pixel Format: <span class="s1">&#39;YUYV&#39;</span>
	Name        : YUV 4:2:2 <span class="o">(</span>YUYV<span class="o">)</span>

	Index       : 1
	Type        : Video Capture
	Pixel Format: <span class="s1">&#39;H264&#39;</span> <span class="o">(</span>compressed<span class="o">)</span>
	Name        : H.264

	Index       : 2
	Type        : Video Capture
	Pixel Format: <span class="s1">&#39;MJPG&#39;</span> <span class="o">(</span>compressed<span class="o">)</span>
	Name        : MJPEG
</code></pre></div>



Details k&ouml;nnen unter <a href="#ubuntuusers">[1]</a> und <a href="#gtkdb">[2]</a> nachgelesen werden.

<h2 id="ton">Schritte zum Erfolg - der Ton</h2>

Ich habe mich dazu entschieden den Ton &uuml;ber http als mp3 anzubieten:

Tools zum Aufnehmen und Konvertieren installieren:
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo apt-get install libav-tools alsa-utils
</code></pre></div>

Mikrophon der Soundkarte herausfinden
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo arecord -l
**** Liste der Hardware-Geraete <span class="o">(</span>CAPTURE<span class="o">)</span> ****
Karte 1: C920 <span class="o">[</span>HD Pro Webcam C920<span class="o">]</span>, Geraet 0: USB Audio <span class="o">[</span>USB Audio<span class="o">]</span>
  Sub-Geraete: 0/1
  Sub-Geraet <span class="c">#0: subdevice #0</span>
</code></pre></div>

Daraus ergibt sich die Alsa-Adresse <tt>plughw:1,0</tt>, die wir in den folgenden Init-skript verwenden. Dabei nehmen wir den Ton von der Webcam auf und schicken ihn als mp3 kodiert und als <a href="https://libav.org/avconv.html#rtp">rtp</a> verpackt an localhost. (Dieser Umweg ist deswegen notwendig, weil vlc in der Version vor 2.1 es nicht hinbekommt den Ton direkt von einem Alsa-Ger&auml;t auszulesen.)
<tt>/etc/init.d/audio-record</tt>

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
<span class="c"># /etc/init.d/audio-record</span>

<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides:          audio-record</span>
<span class="c"># Required-Start:    $all</span>
<span class="c"># Required-Stop:     $all</span>
<span class="c"># Default-Start:     2 3 4 5</span>
<span class="c"># Default-Stop:      0 1 6</span>
<span class="c"># Short-Description: audio-record</span>
<span class="c"># Description:       streams soundcard via rtp over localhost</span>
<span class="c">### END INIT INFO</span>

start<span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Starting audiorecord..&quot;</span>
  arecord -f <span class="nb">cd</span> -D plughw:1,0 2&gt;/dev/null <span class="p">|</span> avconv -i - -acodec libmp3lame -ac 1 -ab 128k -re -f mp3 -f rtp rtp://127.0.0.1:1234  1&gt;/dev/null 2&gt;<span class="p">&amp;</span>1 <span class="p">&amp;</span>
<span class="o">}</span>

stop<span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Stopping audiorecord ...&quot;</span>
  <span class="nb">kill</span> -9 <span class="k">$(</span>pidof arecord<span class="k">)</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1
  <span class="nb">kill</span> -9 <span class="k">$(</span>pidof avconv<span class="k">)</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1
<span class="o">}</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
  start<span class="o">)</span>
    start
    <span class="p">;;</span>
  stop<span class="o">)</span>
    stop
    <span class="p">;;</span>
  restart<span class="o">)</span>
    stop
    start
    <span class="p">;;</span>
  *<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 {start|stop|restart}&quot;</span>
    <span class="p">;;</span>
<span class="k">esac</span>

<span class="nb">exit </span>0
</code></pre></div>

Das Ganze greife ich mit vlc ab und biete es als http-stream <tt>/etc/init.d/vlc-http</tt> wieder an:
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>

<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides:          vlc-http</span>
<span class="c"># Required-Start:    $all</span>
<span class="c"># Required-Stop:     $all</span>
<span class="c"># Default-Start:     2 3 4 5</span>
<span class="c"># Default-Stop:      0 1 6</span>
<span class="c"># Short-Description: vlc-http</span>
<span class="c"># Description:       transport rtp from localhost to http</span>
<span class="c">### END INIT INFO</span>

start<span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Starting vlc-http ..&quot;</span>
  su lars -c <span class="s2">&quot;cvlc rtp://127.0.0.1:1234 --sout &#39;#http{dst=:8081/baby.mp3}&#39;&quot;</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1  <span class="p">&amp;</span>
<span class="o">}</span>

stop<span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Stopping vlc-http ...&quot;</span>
  <span class="nb">kill</span> -9 <span class="k">$(</span>pidof vlc<span class="k">)</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1
<span class="o">}</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
  start<span class="o">)</span>
    start
    <span class="p">;;</span>
  stop<span class="o">)</span>
    stop
    <span class="p">;;</span>
  restart<span class="o">)</span>
    stop
    start
    <span class="p">;;</span>
  *<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 {start|stop|restart}&quot;</span>
    <span class="p">;;</span>
<span class="k">esac</span>

<span class="nb">exit </span>0
</code></pre></div>

Jetzt wieder beide neuen Init-skripte mit ... aktivieren.
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo chmod 0755 /etc/init.d/audio-record
<span class="nv">$ </span>sudo update-rc.d audio-record defaults
<span class="nv">$ </span>sudo chmod 0755 /etc/init.d/vlc-http
<span class="nv">$ </span>sudo update-rc.d vlc-http defaults
</code></pre></div>

<p>Zum Testen einfach <tt>http://&lt;ip&gt;:8081/baby.mp3</tt> aufrufen und sich nicht &uuml;ber die 2 Sekunden Verz&ouml;gerung wundern ;).</p>

<p>Alles f&uuml;r nur 50% CPU auf dem PI.</p>
<div class="image">
	<a href="/img/posts/2014-02-09-htop-pi.jpeg" data-lightbox="image-1" title="Auslastung mittels htop auf dem PI">
		<img src="/img/posts/2014-02-09-htop-pi_small.jpeg" alt="Auslastung mittels htop auf dem PI"/>
	</a>
</div>


<h2>Referenzen</h2>
<ol class="sources" start=1>
 <li><a id="ubuntuusers" href="http://wiki.ubuntuusers.de/MJPG-Streamer">http://wiki.ubuntuusers.de/MJPG-Streamer</a></li>
 <li><a id="gtkdb" href="http://www.gtkdb.de/index_36_2098.html">Raspbian: MJPG-Streamer einrichten</a></li>
</ol>

		</text>
	</article>
	
	<div class="row" id="neighbors">
		<div class="col-xs-6 prev">			
			 
				<a href="/2014/02/04/thoughtworks-technology-radar-2014.html" rel="prev" title="Thoughtworks Technology Radar">&laquo; previous</a> 
			 
		</div>
		<div class="col-xs-6 next">			
			 
				<a href="/linux/2014/04/06/hibernate-and-resume-with-dm-crypt.html" rel="next" title="hibernate and resume with dm-crypt under ubuntu">next &raquo;</a> 
			 
		</div>
	</div>
</div>


   <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'lgohlke'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    



	<link href="/js/lightbox-2.6/css/lightbox.css" rel="stylesheet" />
<script src="/js/lightbox-2.6/js/jquery-1.10.2.min.js" defer></script>
<script src="/js/lightbox-2.6/js/lightbox-2.6.min.js" defer></script>
 

				
			</div>
			<div class="col-md-4 recent">
				<h3>recent posts</h3>
				
				<ul>
				
					
						
							<li><a href="/spam/phishing/funny/mails/2014/09/06/best-of-spam-part-I.html">BestOfSpam - +++Geheimdienst ermittelt+++</a></li>
						
					
						
							<li><a href="/sonarqube/plugin/sonar-mojobridge/2014/05/25/sonarqube-plugin-mojobridge-supports-sonarqube-4.2-and-above.html">SonarQube Mojo Bridge now supports Sonarqube 4.2 and above</a></li>
						
					
						
							<li><a href="/backup/system/perl/2014/05/18/clever-backup-compatibility-with-ubuntu-14.04.html">new release of clever-backup fixed compatibility issue with ubuntu 14.04</a></li>
						
					
						
							<li><a href="/ssh/security/hijacking/2014/05/18/SSH-Agent-Forwarding-Is-a-Bug.html">SSH Agent Forwarding Is a Bug</a></li>
						
					
						
							<li><a href="/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html">Rotate and convert videos automatically to h264 in the shell</a></li>
						
					
						
							<li><a href="/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html">Truecrypt mit Keyfiles und pam_exec automatisch mounten</a></li>
						
					
						
							<li><a href="/linux/2014/04/06/hibernate-and-resume-with-dm-crypt.html">hibernate and resume with dm-crypt under ubuntu</a></li>
						
					
						
					
						
							<li><a href="/2014/02/04/thoughtworks-technology-radar-2014.html">Thoughtworks Technology Radar</a></li>
						
					
						
							<li><a href="/2014/01/31/Blog-Relaunch-mit-jekyll.html">Blog relaunched mit Jekyll</a></li>
						
					
						
							<li><a href="/2013/12/09/%22Leading-Change%22-in-einer-Agile-Company.html">Leading Change in einer Agile Company</a></li>
						
					
				
				
				</ul>
				




<div class="share42init" data-path="/img/">
	<span id="share42">
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -0px 0 no-repeat" href="https://www.evernote.com/clip.action?url=http://blog.lgohlke.de/2014/02/09/babyphone-mit-dem-raspberry-pi.html&amp;title=Howto%20Babyphone%20mit%20dem%20Raspberry%20PI" title="Share on Evernote" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -32px 0 no-repeat" href="#" data-count="fb" onclick="window.open('http://www.facebook.com/sharer.php?u=http://blog.lgohlke.de/2014/02/09/babyphone-mit-dem-raspberry-pi.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Facebook" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -64px 0 no-repeat" href="#" onclick="window.open('https://plus.google.com/share?url=http://blog.lgohlke.de/2014/02/09/babyphone-mit-dem-raspberry-pi.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Google+" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -96px 0 no-repeat" href="#" data-count="pin" onclick="window.open('http://pinterest.com/pin/create/button/?url=http://blog.lgohlke.de/2014/02/09/babyphone-mit-dem-raspberry-pi.html&amp;media=null&amp;description=Howto%20Babyphone%20mit%20dem%20Raspberry%20PI', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=600, height=300, toolbar=0, status=0');return false" title="Pin It" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -128px 0 no-repeat" href="#" data-count="twi" onclick="window.open('https://twitter.com/intent/tweet?text=Howto%20Babyphone%20mit%20dem%20Raspberry%20PI&amp;url=http://blog.lgohlke.de/2014/02/09/babyphone-mit-dem-raspberry-pi.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Twitter" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -160px 0 no-repeat" href="/rss.xml" title="Subscribe to RSS feed" target="_blank"></a>
	</span>
</div>

			</div>
		</div>	
	</div>	
	<div id="footer">
	<div class="row contact" itemscope itemtype="http://schema.org/Person">
		<div class="col-xs-4">
			<span itemprop="name">Lars K.W. Gohlke</span>
		</div>
		<div class="col-xs-4">
			<a href="http://www.lgohlke.de/#impressum" itemprop="url" rel="prefetch">impressum</a>
		</div>
		<div class="col-xs-4">
			<a href="https://github.com/lkwg82">github.com/lkwg82</a><br />
		</div>
		
		<span class="version">last changed 2014-09-06 18:00:18 +0200 bd2c017539652abb7084e6a9ea47853b985fbdfd</span>
	</div>
	
</div>
	<script src="/js/ga.js" async></script>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </body>
</html>
