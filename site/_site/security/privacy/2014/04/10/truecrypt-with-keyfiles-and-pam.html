<!DOCTYPE html>
<html lang="de" >
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/>
	<meta name="HandheldFriendly" content="true"/>
        <title>Truecrypt mit Keyfiles und pam_exec automatisch mounten</title>
	<link rel="stylesheet" href="/css/201407230018.min.css"/>
	<link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    </head>
    <body>
	
	<div class="row" id="header">
		<h2 class="title"><a href="/">Erw&auml;hnenswert</a></h2>
	</div>

	<div class="site">
		<div class="row">
			<div class="col-md-8 content">
				
					<div class="post">
	<article itemscope itemtype="http://schema.org/Article">
		<header>
			<time datetime="2014-04-10T21:23:07Z" pubdate  class="date">10 Apr 2014</time>
			<h1 itemprop="headline">Truecrypt mit Keyfiles und pam_exec automatisch mounten</h1>
		</header>
		<text itemprop="text">
		<p>Nachdem ich in im letzten <a href="/linux/2014/04/06/hibernate-and-resume-with-dm-crypt.html">Artikel</a> kurz beschrieben habe, warum ich mich f&uuml;r <a href="http://ww.truecrypt.org">truecrypt</a> entschieden habe, m&ouml;chte ich nun kurz zeigen, wie man mit Hilfe von <a href="http://www.linux-pam.org/Linux-PAM-html/sag-pam_exec.html">pam_exec</a> verschl&uuml;sselte Datentr&auml;ger mit <a href="http://www.truecrypt.org/docs/keyfiles">Schl&uuml;sseldateien</a> einbindet.</p>

<p>Mein System is effektiv hat nur einen menschlichen Nutzer, daher wird im Folgenden nicht nach unterschiedlichen Nutzern unterschieden.</p>

<h2>Ziel</h2>

<p>Eine Zeile pro Datenträger der mit einer Schlüsseldatei mit Hilfe von <tt>pam_exec</tt> gemountet wird.</p>

<div class="highlight"><pre><code class="bash">session    optional        pam_exec.so ...
</code></pre></div>

<p>Die Integration mit <tt>pam_mount</tt> habe ich nicht in Betracht gezogen, weil mir keine Möglichkeit zum sicheren Identifizieren der Festplatten (siehe unten) ersichtlich war.</p>

<h2>Vorgehensweise</h2>

<ol>
  <li><a href="#enc">Verschlüsseln der Datenträger</a></li>
  <li><a href="#id">Identifizieren der Datenträger</a></li>
  <li><a href="#pam">Einbindung mit pam_exec</a></li>
  <li><a href="#debug">Tipps zum Debugging</a></li>
</ol>

<hr/>

<h2 id="enc">1. Verschlüsseln des Datenträgers</h2>

<p>Hier verweise ich auf Truecrypt im <a href="https://wiki.archlinux.de/title/TrueCrypt">ArchLinux Wiki</a> oder man nimmt einfach die GUI.</p>

<h2 id="id">2. Identifizieren der Datenträger</h2>

<p>Mittels <code>blkid</code> erscheinen die verschlüsselten Datenträger leider nicht auf. Also muss man sie anders ermitteln. Da ich eine 2TB und eine 3TB Festplatte habe, musste ich <code><a href="http://wiki.ubuntuusers.de/gdisk">gdisk</a></code> (f<b>disk</b> für <b>G</b>PT) verwenden.</p>

<p>Weil ich gemischte Partitionstabellen habe (nach alter und neuer Bauart), sind die Identifizierungsnummern der Festplatten mit alter Partitionstablle mit <code>gdisk</code> bei aufeinanderfolgenden Aufrufen nicht identisch:

<div class="highlight"><pre><code class="bash"><span class="c"># erster Aufruf</span>
gdisk -l /dev/sdc <span class="p">|</span> grep <span class="s2">&quot;^Disk identifier&quot;</span> <span class="p">|</span> cut -d<span class="se">\ </span>  -f4 
1DA8415E-997C-4264-8037-C159FEF26AAD

<span class="c"># zweiter Aufruf</span>
gdisk -l /dev/sdc <span class="p">|</span> grep <span class="s2">&quot;^Disk identifier&quot;</span> <span class="p">|</span> cut -d<span class="se">\ </span>  -f4 
A7A3912B-DE0F-4B0A-A6E3-A06DF8E4EDE7

<span class="c"># dritter Aufruf</span>
gdisk -l /dev/sdc <span class="p">|</span> grep <span class="s2">&quot;^Disk identifier&quot;</span> <span class="p">|</span> cut -d<span class="se">\ </span>  -f4 
D16AB7A6-B045-4398-84C2-1236EF6111E1

...
</code></pre></div>
</p>

<p>Da ich nicht schon wieder die ganzen Daten kopieren wollte, musste ein Workaround her. Ich habe mich dann an die Seriennummern von Festplatten erinnert und mit <code>hdparm</code> ermitteln können:

<div class="highlight"><pre><code class="bash">hdparm -i /dev/sdc <span class="p">|</span> grep SerialNo <span class="p">|</span> cut -d<span class="o">=</span> -f4
6XW139KA
</code></pre></div>

<h2 id="pam">3. Einbindung mit pam_exec</h2>

<p>Nun noch die Integration mit <tt>PAM</tt>.</p>

<p>Hierzu bitte ins Verzeichnis <tt>/etc/pam.d</tt> wechseln und die Datei <tt>login</tt> öffnen. Dort sehen wir, dass auf <tt>common-session</tt> verwiesen wird:

<div class="highlight"><pre><code class="bash">...
<span class="c"># Standard Un*x account and session</span>
@include common-account
@include common-session
@include common-password
...
</code></pre></div>

</p>

<p>
Dort stand bei mir bisher:

<div class="highlight"><pre><code class="bash">...
session required        pam_unix.so
session optional        pam_winbind.so
session optional        pam_mount.so    debug
session optional        pam_systemd.so
session optional        pam_ecryptfs.so unwrap
session optional        pam_ck_connector.so nox11
</code></pre></div>

<code class="warning">Bitte <tt>pam_exec</tt> nur als <b>optional</b> konfigurieren. Denn sollte etwas beim Anmelden schief gehen, würde man sich eventuell aussperren.</code>

<p>Das sieht dann so aus:</p>

<div class="highlight"><pre><code class="bash">...

session optional        pam_ecryptfs.so unwrap
session optional        pam_ck_connector.so nox11

session optional        pam_exec.so     &lt;parameter&gt;
</code></pre></div>

Aus Gründen der Darstellung liste ich <tt>&lt;parameter&gt;<tt> hier separat auf:

<p style="line-height: 3rem">
	<code>debug</code> allg. Flag für das Logging<br/>
	<code>log=/var/log/pam_exec.log</code> Skriptausgaben in diese Datei <br/>
	<code>mountTruecryptByGUID.sh</code> Skript zum Mounten (siehe unten) <br/>
	<code>backup_disk.key</code> Schlüsseldatei <br/>
	<code>Z1F1LF69</code> Seriennummer der Festplatte <br/>
	<code>1</code> Partitionsnummer z.B <tt>/dev/sda<b>1</b></tt> <br/>
	<code>/backup</code> Mountpoint <br/>
 </p>
 
 Alle Pfade sollten natürlich absolut sein ;).
</p> 

<p>
Das Skript dazu sieht dann wie folgt aus:
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>

<span class="nb">set</span> -e
<span class="c">#set -x</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-ne 4 <span class="o">]</span>
<span class="k">then</span>
<span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;Usage: `basename $0` &lt;keyfile&gt; &lt;serialNo&gt; &lt;partition-nr&gt; &lt;mountpoint&gt;&quot;</span>
  <span class="nb">echo </span>
<span class="nb">  echo</span> <span class="s2">&quot;serialNo can be retrieved from &#39;hdparm -i /dev/sda&#39; &quot;</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="nv">keyfile</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">serialNo</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">partition</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">mountpoint</span><span class="o">=</span><span class="nv">$4</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$PAM_TYPE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;INFO running outside of pam&quot;</span>
<span class="k">else</span>
<span class="k">        if</span> <span class="o">[</span> <span class="s2">&quot;$PAM_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;close_session&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;INFO skipping mounting (closing session)&quot;</span>
                <span class="nb">exit </span>0
        <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">function </span>_mount<span class="o">(){</span>
        <span class="nb">local </span><span class="nv">keyfile</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">local </span><span class="nv">device</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">local </span><span class="nv">mountpoint</span><span class="o">=</span><span class="nv">$3</span>

        /usr/bin/truecrypt --text --protect-hidden<span class="o">=</span>no --non-interactive --keyfiles<span class="o">=</span><span class="nv">$keyfile</span> <span class="nv">$device</span> <span class="nv">$mountpoint</span>
<span class="o">}</span>

<span class="k">for </span>device in <span class="k">$(</span>fdisk -l 2&gt;/dev/null<span class="p">|</span> grep ^Disk <span class="p">|</span> sed -e <span class="s1">&#39;s#Disk\ \(.*\?\):.*#\1#g&#39;</span><span class="p">|</span> xargs <span class="k">)</span><span class="p">;</span>
<span class="k">do</span>
<span class="k">        </span><span class="nv">serial</span><span class="o">=</span><span class="k">$(</span>hdparm -i <span class="nv">$device</span> 2&gt;/dev/null<span class="p">|</span> grep SerialNo <span class="p">|</span> cut -d<span class="o">=</span> -f4<span class="k">)</span>

        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$serial&quot;</span> <span class="o">==</span> <span class="s2">&quot;$serialNo&quot;</span> <span class="o">]</span><span class="p">;</span>
        <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;$device $serial&quot;</span>

                <span class="c"># skip if already mounted</span>
                truecrypt --text -l <span class="p">|</span> cut -d<span class="se">\ </span> -f2 <span class="p">|</span> grep <span class="nv">$device$partition</span> &gt; /dev/null <span class="o">||</span> <span class="se">\</span>
                        _mount <span class="nv">$keyfile</span> <span class="nv">$device$partition</span> <span class="nv">$mountpoint</span>
        <span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
</p>

<p>
Geschafft! 
</p>

<h2 id="debug">4. Tipps zum Debugging</h2>

<ul style="line-height: 3rem;">
	<li>das <code>debug</code> Flag in der Konfiguration</li>
	<li>mit dem Schalter <code>set -x</code> im Skript kann man beim Anmelden in jeder Konsole mit <code>sudo su &lt;Nutzername&gt;</code> das Skript testen</li>
</ul>

		</text>
	</article>
	
	<div class="row" id="neighbors">
		<div class="col-xs-6 prev">			
			 
				<a href="/linux/2014/04/06/hibernate-and-resume-with-dm-crypt.html" rel="prev" title="hibernate and resume with dm-crypt under ubuntu">&laquo; previous</a> 
			 
		</div>
		<div class="col-xs-6 next">			
			 
				<a href="/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html" rel="next" title="Rotate and convert videos automatically to h264 in the shell">next &raquo;</a> 
			 
		</div>
	</div>
</div>


   <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'lgohlke'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    


 

				
			</div>
			<div class="col-md-4 recent">
				<h3>recent posts</h3>
				
				<ul>
				
					
						
							<li><a href="/spam/phishing/funny/mails/2014/09/06/best-of-spam-part-I.html">BestOfSpam - +++Geheimdienst ermittelt+++</a></li>
						
					
						
							<li><a href="/sonarqube/plugin/sonar-mojobridge/2014/05/25/sonarqube-plugin-mojobridge-supports-sonarqube-4.2-and-above.html">SonarQube Mojo Bridge now supports Sonarqube 4.2 and above</a></li>
						
					
						
							<li><a href="/backup/system/perl/2014/05/18/clever-backup-compatibility-with-ubuntu-14.04.html">new release of clever-backup fixed compatibility issue with ubuntu 14.04</a></li>
						
					
						
							<li><a href="/ssh/security/hijacking/2014/05/18/SSH-Agent-Forwarding-Is-a-Bug.html">SSH Agent Forwarding Is a Bug</a></li>
						
					
						
							<li><a href="/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html">Rotate and convert videos automatically to h264 in the shell</a></li>
						
					
						
					
						
							<li><a href="/linux/2014/04/06/hibernate-and-resume-with-dm-crypt.html">hibernate and resume with dm-crypt under ubuntu</a></li>
						
					
						
							<li><a href="/2014/02/09/babyphone-mit-dem-raspberry-pi.html">Howto Babyphone mit dem Raspberry PI</a></li>
						
					
						
							<li><a href="/2014/02/04/thoughtworks-technology-radar-2014.html">Thoughtworks Technology Radar</a></li>
						
					
						
							<li><a href="/2014/01/31/Blog-Relaunch-mit-jekyll.html">Blog relaunched mit Jekyll</a></li>
						
					
						
							<li><a href="/2013/12/09/%22Leading-Change%22-in-einer-Agile-Company.html">Leading Change in einer Agile Company</a></li>
						
					
				
				
				</ul>
				




<div class="share42init" data-path="/img/">
	<span id="share42">
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -0px 0 no-repeat" href="https://www.evernote.com/clip.action?url=http://blog.lgohlke.de/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html&amp;title=Truecrypt%20mit%20Keyfiles%20und%20pam_exec%20automatisch%20mounten" title="Share on Evernote" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -32px 0 no-repeat" href="#" data-count="fb" onclick="window.open('http://www.facebook.com/sharer.php?u=http://blog.lgohlke.de/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Facebook" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -64px 0 no-repeat" href="#" onclick="window.open('https://plus.google.com/share?url=http://blog.lgohlke.de/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Google+" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -96px 0 no-repeat" href="#" data-count="pin" onclick="window.open('http://pinterest.com/pin/create/button/?url=http://blog.lgohlke.de/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html&amp;media=null&amp;description=Truecrypt%20mit%20Keyfiles%20und%20pam_exec%20automatisch%20mounten', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=600, height=300, toolbar=0, status=0');return false" title="Pin It" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -128px 0 no-repeat" href="#" data-count="twi" onclick="window.open('https://twitter.com/intent/tweet?text=Truecrypt%20mit%20Keyfiles%20und%20pam_exec%20automatisch%20mounten&amp;url=http://blog.lgohlke.de/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Twitter" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -160px 0 no-repeat" href="/rss.xml" title="Subscribe to RSS feed" target="_blank"></a>
	</span>
</div>

			</div>
		</div>	
	</div>	
	<div id="footer">
	<div class="row contact" itemscope itemtype="http://schema.org/Person">
		<div class="col-xs-4">
			<span itemprop="name">Lars K.W. Gohlke</span>
		</div>
		<div class="col-xs-4">
			<a href="http://www.lgohlke.de/#impressum" itemprop="url" rel="prefetch">impressum</a>
		</div>
		<div class="col-xs-4">
			<a href="https://github.com/lkwg82">github.com/lkwg82</a><br />
		</div>
		
		<span class="version">last changed 2014-09-06 18:00:18 +0200 bd2c017539652abb7084e6a9ea47853b985fbdfd</span>
	</div>
	
</div>
	<script src="/js/ga.js" async></script>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </body>
</html>
