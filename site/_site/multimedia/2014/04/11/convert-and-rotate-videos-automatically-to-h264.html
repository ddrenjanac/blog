<!DOCTYPE html>
<html lang="de" >
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/>
	<meta name="HandheldFriendly" content="true"/>
        <title>Rotate and convert videos automatically to h264 in the shell</title>
	<link rel="stylesheet" href="/css/201407230018.min.css"/>
	<link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    </head>
    <body>
	
	<div class="row" id="header">
		<h2 class="title"><a href="/">Erw&auml;hnenswert</a></h2>
	</div>

	<div class="site">
		<div class="row">
			<div class="col-md-8 content">
				
					<div class="post">
	<article itemscope itemtype="http://schema.org/Article">
		<header>
			<time datetime="2014-04-11T21:23:07Z" pubdate  class="date">11 Apr 2014</time>
			<h1 itemprop="headline">Rotate and convert videos automatically to h264 in the shell</h1>
		</header>
		<text itemprop="text">
		<p>Recently I had the luck to welcome my daughter on earth. I almost welcomed her with my smartphone in my hand recording a video. Actually I did not! But later I did a lot of videos.</p>

<p>I wonder how to not fill up my disk in a few weeks I had to compress them without loosing too much quality.</p>

<p>
This is my solution:

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="c">#set -e</span>
<span class="nb">set</span> +x

<span class="nv">size</span><span class="o">=</span>-1

<span class="k">function </span>determineMaxVideoSize<span class="o">(){</span>
        <span class="nb">local source</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">local </span><span class="nv">width</span><span class="o">=</span><span class="k">$(</span>exiftool <span class="nv">$source</span> <span class="p">|</span> grep -i <span class="s2">&quot;^Image Width&quot;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s#.*: ##&#39;</span><span class="k">)</span><span class="p">;</span>
        <span class="nb">local </span><span class="nv">height</span><span class="o">=</span><span class="k">$(</span>exiftool <span class="nv">$source</span> <span class="p">|</span> grep -i <span class="s2">&quot;^Image Height&quot;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s#.*: ##&#39;</span><span class="k">)</span><span class="p">;</span>

        <span class="nb">local </span><span class="nv">max</span><span class="o">=</span><span class="k">$((</span><span class="nv">$width</span>&gt;<span class="nv">$height</span> ? <span class="nv">$width</span> : <span class="nv">$height</span><span class="k">))</span><span class="p">;</span>

        <span class="k">if</span> <span class="o">[</span> <span class="nv">$max</span> -gt 1280 <span class="o">]</span><span class="p">;</span>
        <span class="k">then</span>
<span class="k">                </span><span class="nv">size</span><span class="o">=</span>hd720<span class="p">;</span>
        <span class="k">else</span>
<span class="k">                </span><span class="nv">size</span><span class="o">=</span><span class="nv">$width</span><span class="s2">&quot;x&quot;</span><span class="nv">$height</span><span class="p">;</span>
        <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>_convert<span class="o">(){</span>
        <span class="nb">local source</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">local </span><span class="nv">target</span><span class="o">=</span><span class="s2">&quot;$1.avi&quot;</span>
        <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$target</span> <span class="o">]</span><span class="p">;</span>
        <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;skipping &#39;$source&#39;, because &#39;$target&#39; already exists&quot;</span>
        <span class="k">else</span>
                <span class="c"># exiftool comes with libimage-exiftool-perl</span>
                <span class="nb">local </span><span class="nv">rotation</span><span class="o">=</span><span class="k">$(</span>exiftool <span class="nv">$source</span> <span class="p">|</span> grep -i ^Rotation <span class="p">|</span> sed -e <span class="s1">&#39;s#.*: ##&#39;</span><span class="k">)</span><span class="p">;</span>

                <span class="nb">declare</span> -A videoFilter
                <span class="nv">videoFilter</span><span class="o">=(</span>
                        <span class="o">[</span>90<span class="o">]=</span><span class="s1">&#39;transpose=1&#39;</span> <span class="se">\</span>
                        <span class="o">[</span>180<span class="o">]=</span><span class="s1">&#39;transpose=1,transpose=1&#39;</span> <span class="se">\</span>
                        <span class="o">[</span>270<span class="o">]=</span><span class="s1">&#39;transpose=1,transpose=1,transpose=1&#39;</span> <span class="se">\</span>
                <span class="o">)</span><span class="p">;</span>

                determineMaxVideoSize <span class="nv">$source</span><span class="p">;</span>

                <span class="nb">local </span><span class="nv">metadata</span><span class="o">=</span><span class="k">$(</span>tempfile<span class="k">)</span>
                avconv -y -i <span class="nv">$source</span> -f ffmetadata <span class="nv">$metadata</span>

                <span class="nb">echo</span> <span class="s2">&quot;rotation: $rotation&quot;</span>
                <span class="nb">local </span><span class="nv">videoFilter</span><span class="o">=</span><span class="s2">&quot;-vf ${videoFilter[$rotation]}&quot;</span>
                <span class="k">if</span> <span class="o">[</span> <span class="nv">$rotation</span> <span class="o">==</span> 0 <span class="o">]</span><span class="p">;</span>
                <span class="k">then</span>
<span class="k">                        </span><span class="nv">videoFilter</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span>
                <span class="k">fi</span>

<span class="k">                </span><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;avconv -xerror -i $source \</span>
<span class="s2">                        -acodec libmp3lame -ab 160000  `# mp3 160kB/s` \</span>
<span class="s2">                        -vcodec libx264 -maxrate 2500k -bufsize 1000000 -r 25 -s $size $videoFilter `# 25fps, 1280x720` \</span>
<span class="s2">                        $target.tmp.avi \</span>
<span class="s2">                        -i $metadata -map_metadata 1 -map 0 `# add dumped metadata`&quot;</span>

                <span class="nv">$cmd</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
                        mv <span class="nv">$target</span>.tmp.avi <span class="nv">$target</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
                        touch -r <span class="s2">&quot;$source&quot;</span> <span class="s2">&quot;$target&quot;</span>
        <span class="k">fi</span>
<span class="o">}</span>

<span class="nb">export</span> -f _convert
<span class="nb">export</span> -f determineMaxVideoSize

find -maxdepth 1 -type f -name <span class="s2">&quot;*MOV&quot;</span> -o -name <span class="s2">&quot;*3gp&quot;</span> -o -name <span class="s2">&quot;*mp4&quot;</span> <span class="p">|</span> xargs -n1 -I <span class="o">{}</span> bash -c <span class="s1">&#39;_convert {}&#39;</span>
</code></pre></div>

I decided to save the script as <tt>convertCamVideo2ArchivVideo.sh</tt> in <tt>~/bin</tt>. So you can run it from everywhere as this path is already in <code>PATH</code>.
</p>

<p>For me it is running perfectly well.</p>
		</text>
	</article>
	
	<div class="row" id="neighbors">
		<div class="col-xs-6 prev">			
			 
				<a href="/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html" rel="prev" title="Truecrypt mit Keyfiles und pam_exec automatisch mounten">&laquo; previous</a> 
			 
		</div>
		<div class="col-xs-6 next">			
			 
				<a href="/ssh/security/hijacking/2014/05/18/SSH-Agent-Forwarding-Is-a-Bug.html" rel="next" title="SSH Agent Forwarding Is a Bug">next &raquo;</a> 
			 
		</div>
	</div>
</div>


   <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'lgohlke'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    


 

				
			</div>
			<div class="col-md-4 recent">
				<h3>recent posts</h3>
				
				<ul>
				
					
						
							<li><a href="/spam/phishing/funny/mails/2014/09/06/best-of-spam-part-I.html">BestOfSpam - +++Geheimdienst ermittelt+++</a></li>
						
					
						
							<li><a href="/sonarqube/plugin/sonar-mojobridge/2014/05/25/sonarqube-plugin-mojobridge-supports-sonarqube-4.2-and-above.html">SonarQube Mojo Bridge now supports Sonarqube 4.2 and above</a></li>
						
					
						
							<li><a href="/backup/system/perl/2014/05/18/clever-backup-compatibility-with-ubuntu-14.04.html">new release of clever-backup fixed compatibility issue with ubuntu 14.04</a></li>
						
					
						
							<li><a href="/ssh/security/hijacking/2014/05/18/SSH-Agent-Forwarding-Is-a-Bug.html">SSH Agent Forwarding Is a Bug</a></li>
						
					
						
					
						
							<li><a href="/security/privacy/2014/04/10/truecrypt-with-keyfiles-and-pam.html">Truecrypt mit Keyfiles und pam_exec automatisch mounten</a></li>
						
					
						
							<li><a href="/linux/2014/04/06/hibernate-and-resume-with-dm-crypt.html">hibernate and resume with dm-crypt under ubuntu</a></li>
						
					
						
							<li><a href="/2014/02/09/babyphone-mit-dem-raspberry-pi.html">Howto Babyphone mit dem Raspberry PI</a></li>
						
					
						
							<li><a href="/2014/02/04/thoughtworks-technology-radar-2014.html">Thoughtworks Technology Radar</a></li>
						
					
						
							<li><a href="/2014/01/31/Blog-Relaunch-mit-jekyll.html">Blog relaunched mit Jekyll</a></li>
						
					
						
							<li><a href="/2013/12/09/%22Leading-Change%22-in-einer-Agile-Company.html">Leading Change in einer Agile Company</a></li>
						
					
				
				
				</ul>
				




<div class="share42init" data-path="/img/">
	<span id="share42">
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -0px 0 no-repeat" href="https://www.evernote.com/clip.action?url=http://blog.lgohlke.de/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html&amp;title=Rotate%20and%20convert%20videos%20automatically%20to%20h264%20in%20the%20shell" title="Share on Evernote" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -32px 0 no-repeat" href="#" data-count="fb" onclick="window.open('http://www.facebook.com/sharer.php?u=http://blog.lgohlke.de/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Facebook" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -64px 0 no-repeat" href="#" onclick="window.open('https://plus.google.com/share?url=http://blog.lgohlke.de/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Google+" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -96px 0 no-repeat" href="#" data-count="pin" onclick="window.open('http://pinterest.com/pin/create/button/?url=http://blog.lgohlke.de/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html&amp;media=null&amp;description=Rotate%20and%20convert%20videos%20automatically%20to%20h264%20in%20the%20shell', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=600, height=300, toolbar=0, status=0');return false" title="Pin It" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -128px 0 no-repeat" href="#" data-count="twi" onclick="window.open('https://twitter.com/intent/tweet?text=Rotate%20and%20convert%20videos%20automatically%20to%20h264%20in%20the%20shell&amp;url=http://blog.lgohlke.de/multimedia/2014/04/11/convert-and-rotate-videos-automatically-to-h264.html', '_blank', 'scrollbars=0, resizable=1, menubar=0, left=100, top=100, width=550, height=440, toolbar=0, status=0');return false" title="Share on Twitter" target="_blank"></a>
		<a rel="nofollow" style="display:inline-block;vertical-align:bottom;width:32px;height:32px;margin:0 6px 6px 0;padding:0;outline:none;background:url(/img/icons.png) -160px 0 no-repeat" href="/rss.xml" title="Subscribe to RSS feed" target="_blank"></a>
	</span>
</div>

			</div>
		</div>	
	</div>	
	<div id="footer">
	<div class="row contact" itemscope itemtype="http://schema.org/Person">
		<div class="col-xs-4">
			<span itemprop="name">Lars K.W. Gohlke</span>
		</div>
		<div class="col-xs-4">
			<a href="http://www.lgohlke.de/#impressum" itemprop="url" rel="prefetch">impressum</a>
		</div>
		<div class="col-xs-4">
			<a href="https://github.com/lkwg82">github.com/lkwg82</a><br />
		</div>
		
		<span class="version">last changed 2014-09-06 18:00:18 +0200 bd2c017539652abb7084e6a9ea47853b985fbdfd</span>
	</div>
	
</div>
	<script src="/js/ga.js" async></script>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </body>
</html>
