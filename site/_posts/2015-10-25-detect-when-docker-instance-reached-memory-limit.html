---
layout: post
title: Detect when docker instance reached memory limit
date: 2015-10-24 21:23:07 UTC
updated: 2015-10-24 13:36:07 UTC
comments: true
categories: memory docker
published: true
# news | tip | story
hint-type: tip
---
<p>
    I'd like to know if my test instance reached the memory limit and behaves a kind of different after that.
</p>

<h2>simple but slightly incorrect approach</h2>
<p>
    Just grab the kernel logs for oom-killer for the particular container id.
    {% highlight bash %}
$ CONTAINER_ID=84ec6201e6a54
$ docker exec $CONTAINER_ID dmesg -T | grep -B2 docker-$CONTAINER_ID | grep -B1 oom-killer
    {% endhighlight %}

    outputs
    {% highlight bash %}
--
[Sun Oct 25 22:06:17 2015] java invoked oom-killer: gfp_mask=0xd0, order=0, oom_score_adj=0
    {% endhighlight %}

    Limitation: This implies that kernel logs before and after are about the same issue.
</p>

<h2>more exact but unprecise approach</h2>
<p>
    {% highlight bash %}
$ CONTAINER_ID=84ec6201e6a54
$ if [ $(docker exec $CONTAINER_ID dmesg -T | grep docker-$CONTAINER_ID | wc -l) -gt 0 ]; then
        echo "there were issues with $CONTAINER_ID:";
        docker exec $CONTAINER_ID dmesg -T | grep docker-$CONTAINER_ID
        echo "--"
        echo "host config looks like (reduced)"
        docker inspect --format="{{json .HostConfig}}" $CONTAINER_ID | python -m json.tool \
            | grep -v ": \"\"" \
            | grep -v ": null" \
            | grep -vE ": 0|-1" \
            | grep -v ": \[\]" \
            | grep -v ": {}"
    fi
    {% endhighlight %}

    outputs
    {% highlight bash %}
    there were issues with 84ec6201e6a54:
     [Sun Oct 25 22:39:53 2015] perl cpuset=docker-84ec6201e6a54c9bf8118bcfa39870cb701961ad29bdb05776880cfe2c2572a2.scope mems_allowed=0
[Sun Oct 25 22:39:53 2015] Task in /system.slice/docker-84ec6201e6a54c9bf8118bcfa39870cb701961ad29bdb05776880cfe2c2572a2.scope killed as a result of limit of /system.slice/docker-84ec6201e6a54c9bf8118bcfa39870cb701961ad29bdb05776880cfe2c2572a2.scope
[Sun Oct 25 22:39:53 2015] Memory cgroup stats for /system.slice/docker-84ec6201e6a54c9bf8118bcfa39870cb701961ad29bdb05776880cfe2c2572a2.scope: cache:240KB rss:4194064KB rss_huge:14336KB mapped_file:0KB writeback:0KB inactive_anon:685848KB active_anon:3508408KB inactive_file:24KB active_file:24KB unevictable:0KB
--
host config looks like (reduced)
{
    "Binds": [
        "/dev/shm:/dev/shm",
        "/tmp/docker_jenkins/m2:/home/build/.m2/repository",
        "/tmp/docker_jenkins/webdriver:/home/build/tmp_webdrivers"
    ],
    "ConsoleSize": [
        0,
        0
    ],
    "LogConfig": {
        "Type": "json-file"
    },
    "Memory": 4294967296,
    "NetworkMode": "default",
    "OomKillDisable": false,
    "Privileged": false,
    "PublishAllPorts": false,
    "ReadonlyRootfs": false,
    "RestartPolicy": {
        "Name": "no"
    },
}
    {% endhighlight %}
</p>

Comments and feedback is welcomed!